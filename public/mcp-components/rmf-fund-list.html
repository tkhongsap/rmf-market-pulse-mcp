<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RMF Fund List</title>
  <link rel="stylesheet" href="./shared/styles.css">
  <style>
    /* Fund List Specific Styles */
    .fund-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }
    
    .fund-list-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--color-fg);
    }
    
    .fund-count {
      font-size: var(--font-size-sm);
      color: var(--color-fg-secondary);
    }
    
    .carousel-container {
      position: relative;
      overflow: hidden;
      margin-bottom: var(--spacing-md);
    }
    
    .carousel-scroll {
      display: flex;
      gap: var(--spacing-md);
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      padding-bottom: var(--spacing-sm);
    }
    
    .fund-card {
      flex: 0 0 280px;
      scroll-snap-align: start;
      background-color: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
      cursor: default;
    }
    
    .fund-card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--color-fg-tertiary);
    }
    
    .fund-card-header {
      margin-bottom: var(--spacing-sm);
    }
    
    .fund-symbol {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--color-fg);
      margin-bottom: 2px;
    }
    
    .fund-name {
      font-size: var(--font-size-sm);
      color: var(--color-fg-secondary);
      line-height: 1.4;
      margin-bottom: var(--spacing-xs);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .fund-amc {
      font-size: var(--font-size-xs);
      color: var(--color-fg-tertiary);
      margin-bottom: var(--spacing-md);
    }
    
    .fund-metrics {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-sm) 0;
      border-top: 1px solid var(--color-border-subtle);
      border-bottom: 1px solid var(--color-border-subtle);
    }
    
    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .metric-label {
      font-size: var(--font-size-xs);
      color: var(--color-fg-secondary);
    }
    
    .metric-value {
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--color-fg);
    }
    
    .nav-value {
      font-size: var(--font-size-lg);
      font-weight: 700;
      color: var(--color-fg);
    }
    
    .nav-change {
      font-size: var(--font-size-xs);
      margin-left: var(--spacing-xs);
    }
    
    .fund-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .carousel-controls {
      display: flex;
      justify-content: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }
    
    .carousel-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
      color: var(--color-fg);
    }
    
    .carousel-btn:hover:not(:disabled) {
      background-color: var(--color-border);
    }
    
    .carousel-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .load-more-container {
      text-align: center;
      margin-top: var(--spacing-md);
    }
    
    /* Loading State */
    .skeleton-card {
      flex: 0 0 280px;
      height: 320px;
    }
    
    .skeleton-line {
      height: 16px;
      margin-bottom: var(--spacing-sm);
    }
    
    .skeleton-line-short {
      width: 60%;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .fund-card {
        flex: 0 0 240px;
      }
    }
    
    @media (max-width: 400px) {
      .carousel-scroll {
        flex-direction: column;
        overflow-x: visible;
      }
      
      .fund-card {
        flex: 1 1 auto;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="widget-container" id="app">
    <!-- Loading State -->
    <div id="loadingState" style="display: none;">
      <div class="fund-list-header">
        <div class="skeleton skeleton-line" style="width: 200px; height: 28px;"></div>
      </div>
      <div class="carousel-scroll">
        <div class="card skeleton-card skeleton"></div>
        <div class="card skeleton-card skeleton"></div>
        <div class="card skeleton-card skeleton"></div>
      </div>
    </div>
    
    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <svg class="empty-state-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="9" y1="9" x2="15" y2="9"></line>
        <line x1="9" y1="15" x2="15" y2="15"></line>
      </svg>
      <div class="empty-state-message" data-testid="text-empty-message">No funds found</div>
      <div class="empty-state-hint" data-testid="text-empty-hint">Try adjusting your search criteria</div>
    </div>
    
    <!-- Error State -->
    <div id="errorState" class="error-state" style="display: none;">
      <svg class="error-state-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <div class="error-state-message" data-testid="text-error-message">Failed to load funds</div>
      <div class="error-state-hint" data-testid="text-error-hint">Please try again later</div>
      <button class="btn btn-primary" data-testid="button-retry" onclick="location.reload()" style="margin-top: var(--spacing-md);">
        Retry
      </button>
    </div>
    
    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
      <div class="fund-list-header">
        <div>
          <h1 class="fund-list-title" data-testid="text-title">Thai RMF Funds</h1>
          <p class="fund-count" id="fundCount" data-testid="text-fund-count"></p>
        </div>
      </div>
      
      <div class="carousel-container">
        <div class="carousel-scroll" id="carouselScroll" data-testid="carousel-scroll"></div>
      </div>
      
      <div class="carousel-controls">
        <button class="carousel-btn" id="prevBtn" data-testid="button-carousel-prev" onclick="scrollCarousel(-1)" aria-label="Previous">
          ‹
        </button>
        <button class="carousel-btn" id="nextBtn" data-testid="button-carousel-next" onclick="scrollCarousel(1)" aria-label="Next">
          ›
        </button>
      </div>
      
      <div class="load-more-container" id="loadMoreContainer" style="display: none;">
        <button class="btn btn-secondary" data-testid="button-load-more" onclick="loadMore()">
          Load More Funds
        </button>
      </div>
    </div>
  </div>

  <script src="./shared/utils.js"></script>
  <script>
    // Global state
    let currentData = null;
    let currentPage = 1;
    
    /**
     * Initialize the widget
     */
    function init() {
      try {
        // Initialize theme
        initTheme();
        
        // Get tool output data
        const toolOutput = getToolOutput();
        
        if (!toolOutput) {
          showError();
          console.error('No tool output available');
          return;
        }
        
        // Extract data from structuredContent or parse from text content
        let data = null;
        
        if (toolOutput.structuredContent) {
          data = toolOutput.structuredContent;
        } else if (toolOutput.content && Array.isArray(toolOutput.content)) {
          // Parse from text content if structuredContent not available
          const textContent = toolOutput.content.find(c => c.type === 'text');
          if (textContent && textContent.text) {
            try {
              data = JSON.parse(textContent.text);
            } catch (e) {
              console.error('Failed to parse text content:', e);
            }
          }
        }
        
        if (!data || !data.funds || !Array.isArray(data.funds)) {
          showEmpty();
          return;
        }
        
        currentData = data;
        renderFunds(data);
        
      } catch (error) {
        console.error('Initialization error:', error);
        showError();
      }
    }
    
    /**
     * Render fund list
     */
    function renderFunds(data) {
      const { funds, pagination } = data;
      
      if (!funds || funds.length === 0) {
        showEmpty();
        return;
      }
      
      // Update fund count
      const totalCount = pagination?.total || data.totalCount || funds.length;
      const fundCountEl = document.getElementById('fundCount');
      fundCountEl.textContent = `Showing ${funds.length} of ${totalCount} funds`;
      
      // Render fund cards
      const carouselScroll = document.getElementById('carouselScroll');
      carouselScroll.innerHTML = '';
      
      funds.forEach(fund => {
        const card = createFundCard(fund);
        carouselScroll.appendChild(card);
      });
      
      // Show/hide load more button
      const loadMoreContainer = document.getElementById('loadMoreContainer');
      if (pagination && pagination.page * pagination.pageSize < totalCount) {
        loadMoreContainer.style.display = 'block';
        currentPage = pagination.page || 1;
      } else {
        loadMoreContainer.style.display = 'none';
      }
      
      // Update carousel controls
      updateCarouselControls();
      
      // Show main content
      showMain();
    }
    
    /**
     * Create a fund card element
     */
    function createFundCard(fund) {
      const card = document.createElement('div');
      card.className = 'fund-card';
      
      // NAV change data
      const navChange = fund.nav_change_percent || 0;
      const navChangeClass = getChangeColor(navChange);
      const navChangeArrow = getChangeArrow(navChange);
      
      // YTD performance
      const ytdReturn = fund.perf_ytd || fund.performance?.ytd || 0;
      const ytdClass = getChangeColor(ytdReturn);
      
      // Risk level
      const riskLevel = fund.risk_level || 0;
      const riskColorClass = getRiskColor(riskLevel);
      const riskText = getRiskText(riskLevel);
      
      const fundSymbol = fund.symbol || 'N/A';
      card.setAttribute('data-testid', `card-fund-${fundSymbol}`);
      
      card.innerHTML = `
        <div class="fund-card-header">
          <div class="fund-symbol" data-testid="text-symbol-${fundSymbol}">${fundSymbol}</div>
          <div class="fund-name" data-testid="text-name-${fundSymbol}" title="${fund.fund_name || ''}">${truncateText(fund.fund_name || 'Unknown Fund', 80)}</div>
          <div class="fund-amc" data-testid="text-amc-${fundSymbol}">${truncateText(fund.amc || 'Unknown AMC', 50)}</div>
        </div>
        
        <div class="fund-metrics">
          <div class="metric-row">
            <span class="metric-label">NAV</span>
            <span class="nav-value" data-testid="text-nav-${fundSymbol}">
              ${formatNumber(fund.nav_value, 4)}
              <span class="nav-change ${navChangeClass}" data-testid="text-nav-change-${fundSymbol}">
                ${formatPercentage(navChange)}
              </span>
            </span>
          </div>
          
          <div class="metric-row">
            <span class="metric-label">YTD Return</span>
            <span class="metric-value ${ytdClass}" data-testid="text-ytd-${fundSymbol}">
              ${formatPercentage(ytdReturn)}
            </span>
          </div>
        </div>
        
        <div class="fund-footer">
          <span class="badge ${riskColorClass}" data-testid="badge-risk-${fundSymbol}">${riskText}</span>
          <button class="btn btn-small btn-primary" data-testid="button-details-${fundSymbol}" onclick="viewDetails('${fundSymbol}')">
            View Details
          </button>
        </div>
      `;
      
      return card;
    }
    
    /**
     * Scroll carousel
     */
    function scrollCarousel(direction) {
      const carouselScroll = document.getElementById('carouselScroll');
      const scrollAmount = 300; // px to scroll
      
      carouselScroll.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
      });
      
      // Update controls after scroll
      setTimeout(updateCarouselControls, 300);
    }
    
    /**
     * Update carousel control button states
     */
    function updateCarouselControls() {
      const carouselScroll = document.getElementById('carouselScroll');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      // Disable prev if at start
      prevBtn.disabled = carouselScroll.scrollLeft <= 0;
      
      // Disable next if at end
      const maxScroll = carouselScroll.scrollWidth - carouselScroll.clientWidth;
      nextBtn.disabled = carouselScroll.scrollLeft >= maxScroll - 10; // 10px tolerance
    }
    
    /**
     * View fund details
     */
    function viewDetails(fundCode) {
      callTool('get_rmf_fund_detail', { fundCode });
    }
    
    /**
     * Load more funds
     */
    function loadMore() {
      const nextPage = currentPage + 1;
      const pageSize = currentData.pagination?.pageSize || 20;
      
      callTool('get_rmf_funds', {
        page: nextPage,
        pageSize: pageSize
      });
    }
    
    /**
     * Show loading state
     */
    function showLoading() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('errorState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'none';
    }
    
    /**
     * Show empty state
     */
    function showEmpty() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('errorState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'none';
    }
    
    /**
     * Show error state
     */
    function showError() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
    }
    
    /**
     * Show main content
     */
    function showMain() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('errorState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    }
    
    // Listen for scroll events to update controls
    document.addEventListener('DOMContentLoaded', () => {
      const carouselScroll = document.getElementById('carouselScroll');
      if (carouselScroll) {
        carouselScroll.addEventListener('scroll', debounce(updateCarouselControls, 100));
      }
    });
    
    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
